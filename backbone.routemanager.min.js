/*!
 * backbone.routemanager v0.1.0
 * Copyright 2014, Tim Branyen (@tbranyen)
 * backbone.routemanager may be freely distributed under the MIT license.
 */
!function(a){"use strict";var b=a.Backbone,c=a._,d=(a.$,b.Router.extend({constructor:function(a){a=a||this;var e=this,f={},g=this.routers={},h=a.routes;return c.each(h,function(h,i){var j,k,l,m=a.prefix;if(m||(m=i||""),"/"===m[m.length-1]?m=m.slice(0,m.length-1):m&&(m+="/"),h.prototype instanceof b.Router)j=h.prototype.constructor,l=h.extend({constructor:function(){var a=b.Router.prototype.constructor;return c.each(this.routes,function(a,b){delete this.routes[b],b=b?m+"/"+b:m,this.routes[b]=a,this[a]=d.handleRoute.call(this,this[a],b)},this),a.apply(this,arguments)},options:b.RouteManager.prototype.options}),k=g[i]=new l,k.__manager__={prefix:m,root:e},c.isFunction(j)&&j.call(k);else if(c.isString(h)&&c.isString(i)){if(m=a.prefix?a.prefix:"",e[h]=d.handleRoute.call(e,a[h],i),a!==e&&delete a[h],i)return f[m+i]=h;f[m]=h}}),this.routes=f,b.Router.prototype.constructor.call(this)},__manager__:{prefix:""}},{configure:function(a){var d=b.RouteManager.prototype.options;return c.isObject(a)?c.extend(d,a):void 0},handleRoute:function(a,d){function e(a,b){var d=j[0],e=c.chain(d[a]);i[a]=i[a]||[],e=e.filter(function(a,c){var d=c?[b,c].join("/"):b===g;return d&&(h=c),d}),e=c.reduce(e.value(),function(a,b){return a.concat(b)},[]),e=c.map(e,function(a){var b,d;return c.find(j,function(e){return c.isFunction(e[a])?(b=e,d=e[a]):void 0}),c.isFunction(d)||(d=function(){}),[b,d]}),i[a]=i[a].concat(e)}function f(a){var b=a.__manager__.prefix;j.unshift(a),e("before",b),e("after",b),a.routers&&c.each(a.routers,function(a){return f(a)})}var g,h,i=[],j=[],k=this,l=(k.options,c.map(d.match(/:(\w+)|\*(\w+)/g),function(a){return a.slice(1)}));return function(){var d=arguments,e=this;g=b.history.fragment,this.params={},c.each(l,function(a,b){this.params[a]=d[b]},this),f(e.__manager__.root||e),c.each(i.before,function(a){a[1].apply(this,d)}),c.each(i.after,function(a){a[1].call(a[0])}),b.history.trigger("after",e,g),j=[],i=[],c.isFunction(a)&&a.apply(this,d)}}}));b.RouteManager=d}(this);